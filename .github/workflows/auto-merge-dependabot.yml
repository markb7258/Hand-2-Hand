name: Auto-Merge Dependabot PRs

# This workflow automatically tests and merges Dependabot PRs
# If a build fails, it uses the auto-downgrade system to find the latest working version

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  test-and-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
        run: npm install --legacy-peer-deps

      - name: Run build test
        id: build
        continue-on-error: true
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
        run: npm run build

      - name: Handle build failure with auto-downgrade
        if: steps.build.outcome == 'failure'
        id: auto_downgrade
        continue-on-error: true
        run: |
          echo "Build failed, checking if auto-downgrade is possible..."
          
          # Extract package name and versions from PR title
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"
          
          # Check if this is a grouped update (no version numbers in title)
          if echo "$PR_TITLE" | grep -q "bump the"; then
            echo "⚠️ This is a grouped dependency update - auto-downgrade not supported"
            echo "Grouped updates require manual review when builds fail"
            gh pr comment "${{ github.event.pull_request.number }}" --body "⚠️ **Build Failed - Manual Review Required**\n\nThis grouped dependency update failed to build. Auto-downgrade is not supported for grouped updates.\n\nPlease review the build logs and update dependencies manually."
            echo "auto_downgrade_result=skipped_grouped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if this is a multi-package update (e.g., "bump react and @types/react")
          if echo "$PR_TITLE" | grep -q " and "; then
            echo "⚠️ This is a multi-package update - auto-downgrade not supported"
            echo "Multi-package updates require manual review when builds fail"
            gh pr comment "${{ github.event.pull_request.number }}" --body "⚠️ **Build Failed - Manual Review Required**\n\nThis multi-package update failed to build. Auto-downgrade is not supported for multi-package updates.\n\nPlease review the build logs and update packages manually."
            echo "auto_downgrade_result=skipped_multi" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Single package update - attempt auto-downgrade
          # Example PR title: "chore(deps): bump next from 14.0.0 to 14.2.0"
          PACKAGE=$(echo "$PR_TITLE" | grep -oP 'bump \K[^ ]+' || echo "")
          CURRENT_VERSION=$(echo "$PR_TITLE" | grep -oP 'from \K[0-9.]+' || echo "")
          NEW_VERSION=$(echo "$PR_TITLE" | grep -oP 'to \K[0-9.]+' || echo "")
          
          if [ -z "$PACKAGE" ] || [ -z "$CURRENT_VERSION" ] || [ -z "$NEW_VERSION" ]; then
            echo "⚠️ Could not parse package information from PR title"
            echo "Package: $PACKAGE, Current: $CURRENT_VERSION, New: $NEW_VERSION"
            gh pr comment "${{ github.event.pull_request.number }}" --body "⚠️ **Build Failed - Manual Review Required**\n\nCould not parse version information from PR title. Please review the build logs and update manually."
            echo "auto_downgrade_result=parse_failed" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if this is a major version update (likely has breaking changes)
          CURRENT_MAJOR=$(echo "$CURRENT_VERSION" | cut -d. -f1)
          NEW_MAJOR=$(echo "$NEW_VERSION" | cut -d. -f1)
          
          if [ "$NEW_MAJOR" -gt "$CURRENT_MAJOR" ]; then
            echo "⚠️ Major version update detected: $CURRENT_VERSION -> $NEW_VERSION"
            echo "Major version updates often have breaking changes that require manual migration"
            gh pr comment "${{ github.event.pull_request.number }}" --body "⚠️ **Build Failed - Major Version Update Detected**\n\nThis update from **$CURRENT_VERSION** to **$NEW_VERSION** is a major version jump that likely requires manual migration.\n\n**Next Steps:**\n1. Review the package's migration guide\n2. Update code to be compatible with v$NEW_MAJOR\n3. Test thoroughly before merging\n\nAuto-downgrade was not attempted as it would only find older versions."
            echo "auto_downgrade_result=major_version" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Running auto-downgrade for $PACKAGE ($CURRENT_VERSION -> $NEW_VERSION)"
          chmod +x scripts/auto-downgrade.sh
          
          # Run auto-downgrade script (continue even if it fails)
          if bash scripts/auto-downgrade.sh "$PACKAGE" "$CURRENT_VERSION" "$NEW_VERSION"; then
            # Check if a working version was found
            if [ -f /tmp/working-version.txt ]; then
              WORKING_VERSION=$(cat /tmp/working-version.txt)
              echo "Found working version: $WORKING_VERSION"
              
              if [ "$WORKING_VERSION" != "$CURRENT_VERSION" ]; then
                echo "Creating new commit with working version $WORKING_VERSION"
                npm install --legacy-peer-deps "${PACKAGE}@${WORKING_VERSION}"
                git config user.name "github-actions[bot]"
                git config user.email "github-actions[bot]@users.noreply.github.com"
                git add package.json package-lock.json
                git commit -m "chore(deps): downgrade $PACKAGE to $WORKING_VERSION (auto-downgrade)"
                git push
                echo "auto_downgrade_result=success" >> $GITHUB_OUTPUT
              else
                echo "Working version is same as current version, no changes needed"
                echo "auto_downgrade_result=no_change" >> $GITHUB_OUTPUT
              fi
            fi
          else
            # Auto-downgrade script failed to find a working version
            echo "⚠️ Auto-downgrade could not find a working version"
            gh pr comment "${{ github.event.pull_request.number }}" --body "⚠️ **Auto-Downgrade Failed**\n\nThe auto-downgrade system tested versions between **$CURRENT_VERSION** and **$NEW_VERSION** but could not find a version that builds successfully.\n\n**Recommendation:** Stay with current version **$CURRENT_VERSION** until the issue is resolved.\n\n**Next Steps:**\n1. Review the build failure logs\n2. Check if there are breaking changes or dependency conflicts\n3. Consider updating other dependencies that may be incompatible\n4. Close this PR for now"
            echo "auto_downgrade_result=no_working_version" >> $GITHUB_OUTPUT
            exit 0
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Re-run build after auto-downgrade
        if: steps.build.outcome == 'failure' && steps.auto_downgrade.outputs.auto_downgrade_result == 'success'
        id: rebuild
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
        run: npm run build

      - name: Auto-merge PR
        if: steps.build.outcome == 'success' || steps.rebuild.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge --auto --squash "${{ github.event.pull_request.number }}"
          echo "PR #${{ github.event.pull_request.number }} approved and queued for merge"
