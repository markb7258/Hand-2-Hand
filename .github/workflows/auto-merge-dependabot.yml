name: Auto-Merge Dependabot PRs

# This workflow automatically tests and merges Dependabot PRs
# If a build fails, it uses the auto-downgrade system to find the latest working version

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  test-and-merge:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Run build test
        id: build
        continue-on-error: true
        run: npm run build

      - name: Handle build failure with auto-downgrade
        if: steps.build.outcome == 'failure'
        run: |
          echo "Build failed, attempting auto-downgrade..."
          
          # Extract package name and versions from PR title
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR Title: $PR_TITLE"
          
          # Example PR title: "chore(deps): bump next from 14.0.0 to 14.2.0"
          # Extract: package=next, current=14.0.0, new=14.2.0
          PACKAGE=$(echo "$PR_TITLE" | grep -oP 'bump \K[^ ]+' || echo "")
          CURRENT_VERSION=$(echo "$PR_TITLE" | grep -oP 'from \K[0-9.]+' || echo "")
          NEW_VERSION=$(echo "$PR_TITLE" | grep -oP 'to \K[0-9.]+' || echo "")
          
          if [ -z "$PACKAGE" ] || [ -z "$CURRENT_VERSION" ] || [ -z "$NEW_VERSION" ]; then
            echo "Could not parse package information from PR title"
            echo "Package: $PACKAGE, Current: $CURRENT_VERSION, New: $NEW_VERSION"
            exit 1
          fi
          
          echo "Running auto-downgrade for $PACKAGE ($CURRENT_VERSION -> $NEW_VERSION)"
          chmod +x scripts/auto-downgrade.sh
          bash scripts/auto-downgrade.sh "$PACKAGE" "$CURRENT_VERSION" "$NEW_VERSION"
          
          # Check if a working version was found
          if [ -f /tmp/working-version.txt ]; then
            WORKING_VERSION=$(cat /tmp/working-version.txt)
            echo "Found working version: $WORKING_VERSION"
            
            if [ "$WORKING_VERSION" != "$CURRENT_VERSION" ]; then
              echo "Creating new commit with working version $WORKING_VERSION"
              npm install --legacy-peer-deps "${PACKAGE}@${WORKING_VERSION}"
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git add package.json package-lock.json
              git commit -m "chore(deps): downgrade $PACKAGE to $WORKING_VERSION (auto-downgrade)"
              git push
            fi
          fi

      - name: Re-run build after auto-downgrade
        if: steps.build.outcome == 'failure'
        run: npm run build

      - name: Auto-merge PR
        if: steps.build.outcome == 'success' || steps.build.conclusion == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge --auto --squash "${{ github.event.pull_request.number }}"
          echo "PR #${{ github.event.pull_request.number }} approved and queued for merge"
