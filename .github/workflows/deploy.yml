name: Deploy to Coolify

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit for potential revert
      
      - name: Get commit info
        id: commit
        run: |
          CURRENT_COMMIT="${{ github.sha }}"
          PREVIOUS_COMMIT=$(git rev-parse HEAD^)
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)
          echo "current=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
          echo "previous=$PREVIOUS_COMMIT" >> $GITHUB_OUTPUT
          echo "message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "Current: $CURRENT_COMMIT"
          echo "Previous: $PREVIOUS_COMMIT"
          echo "Message: $COMMIT_MESSAGE"
      
      - name: Trigger Coolify Deployment
        id: deploy
        run: |
          echo "Triggering deployment for commit ${{ steps.commit.outputs.current }}"
          RESPONSE=$(curl -s -w "\n%{http_code}" -X GET \
            "http://196.251.100.142:8000/api/v1/deploy?uuid=dw4040kw4ok440w48o4k4880&force=false" \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_API_TOKEN }}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "‚ùå Deployment trigger failed with status $HTTP_CODE"
            echo "deploy_triggered=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ Deployment triggered successfully"
          echo "deploy_triggered=true" >> $GITHUB_OUTPUT

      
      - name: Wait for deployment to stabilize
        if: steps.deploy.outputs.deploy_triggered == 'true'
        run: |
          echo "Waiting 60 seconds for deployment to stabilize..."
          sleep 60
      
      - name: Health check deployment
        id: health
        if: steps.deploy.outputs.deploy_triggered == 'true'
        run: |
          echo "Checking application health..."
          MAX_RETRIES=5
          RETRY_COUNT=0
          HEALTH_URL="http://196.251.100.142:3000"
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: HTTP $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Application is healthy (HTTP 200)"
              echo "healthy=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Retrying in 10 seconds..."
              sleep 10
            fi
          done
          
          echo "‚ùå Application failed health check after $MAX_RETRIES attempts"
          echo "healthy=false" >> $GITHUB_OUTPUT
          exit 1
      
      - name: Revert on deployment failure
        if: steps.health.outputs.healthy == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîÑ Deployment failed - reverting to previous commit"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create revert commit
          git revert --no-edit ${{ steps.commit.outputs.current }}
          
          # Push revert
          git push origin main
          
          echo "‚úÖ Reverted to commit ${{ steps.commit.outputs.previous }}"
          echo "Failed commit: ${{ steps.commit.outputs.current }}"
          echo "Revert will trigger automatic redeployment"
      
      - name: Notify success
        if: steps.health.outputs.healthy == 'true'
        run: |
          echo "‚úÖ Deployment successful!"
          echo "Commit: ${{ steps.commit.outputs.current }}"
          echo "Application is healthy and serving traffic"
      
      - name: Notify failure
        if: steps.health.outputs.healthy == 'false'
        run: |
          echo "‚ö†Ô∏è Deployment failed and was reverted"
          echo "Failed commit: ${{ steps.commit.outputs.current }}"
          echo "Reverted to: ${{ steps.commit.outputs.previous }}"
          echo "Check logs for details"
